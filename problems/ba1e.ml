open! Core

(* http://rosalind.info/problems/ba1e/ *)

let tally kmer pos map =
  let r = Map.find map kmer in
  match r with
  | None -> Map.set map ~key:kmer ~data:[ pos ]
  | Some x -> Map.set map ~key:kmer ~data:(pos :: x)
;;

let is_clump k l t list =
  let a = Array.of_list list in
  let rec loop i =
    if i + t > Array.length a
    then false
    else if a.(i + t - 1) + k - a.(i) <= l
    then true
    else loop (i + 1)
  in
  loop 0
;;

let%expect_test "" =
  print_s [%sexp (is_clump 3 8 3 [ 1; 25; 26; 100 ] : bool)];
  [%expect {| false |}]
;;

let now_its_own_function genome k =
  let rec loop i map =
    if i = String.length genome - k + 1
    then map
    else loop (i + 1) (tally (String.sub ~pos:i ~len:k genome) i map)
  in
  loop 0 (Map.empty (module String))
;;

let main genome k l t =
  Map.fold
    (now_its_own_function genome k)
    ~init:[]
    ~f:(fun ~key:kmer ~data:positions clumps ->
      if is_clump k l t positions then kmer :: clumps else clumps)
;;

let%expect_test "" =
  print_s
    [%sexp
      (main
         "TTATGGTAAGCACTACACAATTCATTCTTTAAATCAAATAGTAACTGTGTCTTTATTGGGTAGAAAGTTGCGTCCTGGTTACCCCTTCCAGTCGTCCTGAGAATATTGCCTCTGATGGATAACTGGGACTTAAATGCCCTAAGCCGGACAAGGCGGTTATGTCGATGTGTGCGAAACTGACTGTCATAACGCGACGATGACGTGGATTAAAACTGAACTCTTTTTAAATACCGATACGTTGACCGACCCACGAACACTTGGCCCGATGGTGAAGCTTGGGGGCTGACCTGGTGGAAGAGATGTCCTCGCGGAAGAGGTTAGGGCCTCATGCCCCCCCCGGATCTCCCACCATATGGCGTCAGTGGTGTCACGGAGATGCGCCTATATGATTTTCGGGTGGTACCCAACGTTGGTCCTGAGCTCACGAGGCGAAAGCACCACGTTCAAGGTTGTTGAATGATTGCCAGATCCACTCAAGTTGAATTGTTCCCAGCGAAGAGACTAGACTAGACACGATGTCTGGAGTCCATTTAGTATCGGAAGTTACAACGGGCTCCCACTGCATGAGGCGGGTAACTAAATGTTGGCGTAAACACATGCGTTGGGACCGGGGTCGGAAAGCTTTAAAATTGCGAAGGGAAGCATTACGTTCGATTACGATTACGTTCAATTACGTTCCAACGCTACTGCTGGAATTGAGTTGCTAGCTAACATTACGTTATTACGTTCTACGTTCATCTCAGGACATTACGTTCTGGGAGGTAAGTGAGAGGACCTAGATTATGCGGGGCCCCTCCGTATCCAGCTCCAGACTGACTAACAGGGATGCAATTACGTTCTATTACGTTCGAATTACGTTCCCTAAAGGCATTACGTTCACTATGCACCTGTAAATCTATTACGTATTACGTTCCCATAGCACCGGGATTACGTTCGTACCACGTACATGGGTGGAAAAAACCAAAGCACTAATTACGTTCGCATTGGCCTTGCAGCCGGCCTTGCACGCATCCATTATTACGTTCCTCCTGTGTTCCGCCGGGCCTTGCAGCAAGGCCTTGCACCTTGCGGCCTTGCACCTTGCAAAGACGGTATGGGCCTTGCATGGCCTTGCAGCGGCCTTGCAGTTCGCTCAACAGAAGGCCTTGCATGCAGGCCTTGCACGATCCTTGCTCTAGGCCTTGCATACGTTCACGCTCAGAAGGCCTCAATGCATTACGTTGGCCTTGCAGGCCTTGCACACTACGGCCTTGCATAAGCAATACAAGTGATGAACACGATCACCCTGGCCTTGCAGGGGTCCGGTAAGGCCTTGCAACGGCCTGGCCTTGCACGCGCCACTTTGGAAGTGGGAGCGGATTTGGGACTCCCTATATGGCCTTGCAGGCCTTGCAAGATCCTTGCTTAGGCCTTGCAGCCCATTCGCCCGCATGTTGTTTTCGATGTCGACGGAGAGCAGCGGGGCCTTGCAACTGCTCAACCCTGGACTGCCGGCCTTGCATTGCACCAGGGGCCTTGCAGGTCACACGGGCCTTGCAGCCCTAGCGGCCTTGCAAGTACCTGTCGCCCTCGGACTATGCGTAGTCTTTATGCAGTCGCCCGCGATCACAATGAGGTTTCTCCGCGGAAGTGACCTCCGAGAGCGTGTGCTAATAACAATGGAATAATCTGCTTTCACACGTACGTGCAGCTTCCGGGACAAGGACAGTTTGAAGAGTAGACCGTAGCGCACCTAACGGTTAAGTGGCCGTTGATGACACACCTCTCATCCCGCACTAGACCGTAGACCGTAGTCTGCTGTACTCAGACCGTAGACAACTTTTGCGTGACTAGACCGTAGTTGTCAAAGACCTAGACCGTAGACTCATTAACTGTGTAAGACCGTAGAGAGCTGTTGAGACCGTAGTAGTCGTAGACCGTAGTGACGACTTATTTTGGAGACCGTAGTCGGAGACCGAGACCGTAGGACCGTAGCTCAAGACCGTAGCGGCCAAACGAGGAGTTGCAGACCGTAGTTGCCAGAGTAAAGACCGTAGTCTTAGCCACGGAGCTAAATCTCACTAGACCGTAGAGCTGCTGTTCAAGCCAAAGAGGAGACGGGCCCAAGTTCATTCACCAAGACCGTAGACCGTAGGTGTACCAGTCAAAACATCGTAAACTTAATCGGCGTATAACAATAAGACCAGACCGAGACCGTAGGCCTGCGCTTAGATTTGGCATATTGGCCCGCTCTTGTAATTGCAAGAAGACCGTAGAGCAGACCGTAGGACCAAGACCGTAGCTTACCACGGGGGACCTCATAGTGAGGCGAATAGCATCGTCTATATTAGTTAACTAAGGCAACGAGCCCTACGCTTCAGTTCCAGAAGTTTGCCCCCATAACCTCCACATTCAGGCTTCCGTTGGACAATATCCGCGATGCCAAGAGGTTTTATGATGTTCTTCCCCAGCATCTTCTGCATGATCATTGCAAGCCACTTGTTTCGCAGTACGTGACGTAACTCAGCCAACGTACCGGGGCCCGTTATATGAGACATTCGTTAAGATCCCTGGCCCCCGCCCGCTTGTCTTATGTGCGGATGCCTACTGCTCGCGAGCCCACGAGCCAGGAAATCGATTCCAGAACACACTCACAGACCCGGTGCTGTCTAGACCCACTCGAGCTAGGGAGCGTCCAACAGTCCACGCGGTGCTTAGGTAAGCGTCAAGTACTTGCGCGTTGCTAGCGTGACCTTGCTATCATGAAAACTCCAGGAGAAGCGCTATACAGAGCGATCTCTTTCGGTTAGACCACAGTCGGGAGCTGATAATGTAGCCTGGAAACACGGGCAAAAGGCAATCCCTTATTTATCTGCGGGGAGTGAGATGCTAACAAGTGTTGAGTAAACGGCTTCGAGACCGGTGGCGACACCTTCCAGTGACGAAAGCCGACAACATGGAGTGTAGTCGAGGTTTCTTGCTCCTAGAAGGGGACATTTGCATTATCCTCAGGATGACAGCGCTCATAGACTAATGAAATGCGTGCGCCCGCTCCGAACGATACAGTCCACCACAATGGTTTCAGTTCGTTATACGGCATCAAGAGCGCAGCTTGAAAGGCCTCGTCGGCATAGCGTGTCAACCAATAACACCTCACGGCCAACTTTGTCATGCGGCAGTGAACAGAAACCTTGGGTCTCTGATTAGTGATAGGCACAATGCCACGAGGACCTTCGGACGCAACAGGTAACGGCCTATATTGACCAGTGCACGAGAAGGTGTGTTCACAGGTAACCAGGCACAGGTAACGCACACGATTTGTTAGAACAGGTAACCAACCCTAAGCAAAGTCCATATGAATCTCTGGCAGAAGACAGGAACGGTGCGCATATAACGCAACTGGATTTGCTATACAGGTAACACAGGTAACTTTATCGTCGCATCTTACAGGTAACTACACATGAGGTTTCGACTAGTTTCCAATACGCGCCATAGACCTGTCGGAAACAGGACAGGTAACTTCGAAGTCATGCCCGTGGTACAGGTAACAAATCGGTGTGATTGCCTGTCTTCCCATAAAATACATCGGGACAGGTAACGGGACTTCATACTACAGGTAACAGGTAACTCACGTACAGGTAACAGGTAACTGCACAGGTAACCTACTTAGGTCCTAACAGGTAAACAGGTAACTAACACAGGTAACTAACCAGCCTGTCATTAACAGGTAACCCCCATACAGGTAACCGGATGACGATTCGCTCCACAGGTAACCTCACAGGTAACCTACAGGTAAACAGGTAACACGTGCTGACACCATTGTTTCGGGGTGAACGAGATACCTACTCAGTCAGTTGGATCTGATAAGCGAGCCCAGATGGTGCAACACCAGGTTTAGCCGTGATTCAGGAAAAAAGTTATGTATTGTATTCTTCCTGCTCGGACACCGCTGCGCCAGTAAATCCGCTTATTACTGCCATATCGAAGGTCGGCGCACATCCACTAAGATTTAACCGCAAGGTATTTTGTCAAGTTGGTACAGAAGTAGCTTTCCCCACGTCCAGAGGTTCCGCGAGCGCATGCGCTTTTTGACCCTTTGGATCGACGTCAAGTATCACTAGCTGCGTTGATTCGATTGTTCGTGAGTATAGGCAGTCCCGGTCAAAGATAGTGCTCGCAACAGTCACTCGCCGCTTTGTGTATGGGGCCCACTCAACCCGGGCACCTACCTCTGCCGTCTTGGAATTCCCGGGGGATATATGTCGCAGAAATCGCCTATGAATCTAATTATACCCCTACGGCGTTACCTCAGTTGTTGGCTACTCACGGGCACCTGATGATTTGAGCTCGGTGGGCGAGCATCTTCGAAGGAAGAATGCAACATTGCTACGTGTTAATGGGAATTTGACATTCTACGGATTCAGGTCTAGGTAGTTAAAAAACCCTGCTATGTGCCTGCTATTACTTTCTAAAAGGAGTATAAGCAAGTTTAGGATCTGGTCTACTAGCTTTCCTATTATAGTGGCGCCGGGTGGAAACGAGTGGTTTGACTTGAGTGGATCGGCGTAGTCCCATACCGCGGCGTCGTGAGGTCGCCTGTCAGTCTCCAAGCGTTGCTGGCTAGATCGCCTTTTGGATATCGCATATAATCTCAATATGAGCAGGCCGTCGTCTGGGGAACTAACCTACATCGATTTTTGCCGGAAGAGGCTGTTTGACTGATGGGGCTGTTTGAAGTGTGCGCAGGCCGGGAGGCTGTTTGAGCCCCATAGGAAAGGTGTCATAGTTGACCGGGATAGAACGACTGAGGCGCTGTTTGATGACCTCTGCTGTTTGAAATCACGCTGTACGCAGAACGTCGGGGTTCGAGGAATACGCTAGGATGCTGTTTGACGCTGTTTGAGACTGCAAGTGAGATCTCCGCTGTTTGATTACAGCTGTTTGGCTGGCTGTTTGACGAGGGTAAGGCTGTTTGAAACAAACCCCCCACGGCTGTTTGAGTTTCACAGTCTGTTAGGGGGCAAGTGCGTTCCACCCCTGCGCTGTTTGAGCTGTTTGACAGCGAAACCGCGCTGGCTGTTTGACAACAACCGCCAAGGCAGCCCCGCTGTTTGAAACCGGACAGGCTCATAACCGCCAAACGAAAGCTGTTTGAAAACGGCTGTTTGACAAACCGCCAATGGACGCGGGCTGTTTGACCAACTAAGTGGCTGTTTGAGACGCCAAGTCCGTAACCGCCAACCAAGGCTGTTTGAAACCGCCAAAACCGCCAATTGTTGCTGTTTGAAGCTGTTTGATAAGTCTATGCCGGCGTCCGCGCCATGGACATGTCACCTTAAAGGAAACCGCCAACAACCTCCAAACCGCCAACCGCCAAGCCGGCAATTTTGTGCACAGATGGGCGGATTGAACCGCCAACCGCCAAAATTAAATACAACCGCCAAATGATATCAAACCGCCAACAAGGCCTTCCCGTCTAAAGTAGAACTAGATGAGATTCTGGCAAACACGCGGGAGTAGTGGCCACTTGATTTGAACTAACCGCCAATAGGCATCAACCGCCAAACCGCCAATCATTCCAAACCGCCAAGAAAAGCGGAACCGCCAAAAGGCTAGGGTTGAAGACTGTAAGCTAGAACGCTCACAGACATTTTGTTTCAAGAAGATATGCTGTCGGAACCGGGCCCAAATCACTGGTCTCCCAGAGGCCAGAAAGGACATCATTCTCCCGTGGCCTCCACAACATTGGCGCCTTGACCGACCCATGAGCCATGAGGCGGGTTCAGGCACTACTATGTATTTAAAAGCTTGTCGCTGGTACCCATGAGCCACCCATGAGATGAGCACCCACCCAACCCATGAGTACCCATGAGATTTCGCCTATTACCTTACCCATGAGGTTGCGCGTATACCCATGAGAGATCGCCAGCTCTCTGGCGAAACTACCCATGAGCCATGAACCCATGAGGAGGCGTATCGCCTACGATTCTGGGTGACTAAGCACCCATACCCATGAGCACCCATGAACCCATGAGAACGCGACTAGAACCCATGAGATATTCCGTGATTGTATCTAATCATACCCATGAGTTGTAAATAACCCATGAGCCATGAGCGTCACCCATGAGGAGAGCTAGCGGACCCATGAGCCATGAGGGTACAGCTAACCGGGTTTGTTTACGATTGACGGCTTTGCAGCTCAGACGAACGGGCCCTGTTATCTAACAACACTCAGTAAGTAACCCATGAGCATCATCTAAGACGATCAATTGACGAGCAAATAGTCCAACGTACTGAACAAGACCGTTTTGGCGCGAACGCAAATAGTCCAGCCTGCAACCCATGAGCATGGATTTGTTACATAGCAGCCCAACCTCCAAAGAAGAAATAGTAAATAGTCCGTTAGCAAATAGTCCATTTTTTCTATTATTGCCAGATAGAGGAAATAGTCCAAATAGTCCCCAAATAGTCCGTTCATATGTCATATGGTTCATATGTGAAATAGTCCTCGATTGTGTAGGCCATGACAGTTCATATGTCATATGCCTAGAAATAGTCCGTTGGGTTACCCCGTAAATAGTCCTCTAAATAGTCCATGGGCCAAGTTCAAATAGTAAATAGTCCATACGGAAATAGTCAAATAGTCCAAATAGTCCAAAGTCCGCCAAGTTCATATGTCAAATAGTCCGATCCGCCAAAAAAATAGTCCGTATAATTACCGAAATAGTCCTATGAAGTTAAATAGTCCGACCGCCAAAAAAATAGTCCAAAATAGTCCAAACTTTATCTTTGTTAGCCGCCAAAATAGTCCAAATAGTCCTCCGCCAAAAGTTCATATGTAACCCAAAAATAGTCCAGCAAAATAGTCCAAGTTCATATGATACTGTTCATATGGTTCATATGAGCCGTTCATATGTACTGCGTGTGCGGCGTTCATATGCGCCAAAACTGTTCATATGTGCGTGTGGTCCGCCAAAATGGCTTGTTCATATGATCGGTCTGCGTGTTCATATGCTGCGTGTGAACGGGACCGGGTTCATATGCGTTCATATGGCGTGTGTGCGTGTGTAGCGTCCGCCAAAATGCTTCATCCGCCACCGCCAAAAAACTAGCCAATAACCGCCCTGCGTCTGCGTGTGGTGCCGCCAAAAAAAGCTGCGTGTGCGCTGCGTGTGGCGTGTGAATGGGAGTATCCTGCGTGTGTGCGTGTGGTGGCGTGTGTGACTGCGTGTGTAACGCCCTGTGAAGTGCGTGGTAAACTGCGTGTGACGAGGCGTGCTGCGTGTGGAAACGCACCCCAACCGGGTGAACTCGAGCCTACTAAGAGGCGCTTAAAACTTGGTCCAGCTGCGTGTGGAGATCTTCAAATCATATGAGAAATATGCCTGCGTGTGGCGGCGAGTGAGCCCTGTTCTGCGTGTGGAACATCTTAGTTCGGGCTGCGCTGCGTGTGCTCGCCGAACCACTGCGTGTGCGAATTCGGCTCTGTCAGTCTTCAAGCCTCTTGAGAACTTACTTACTCGTTGGTGACATTACGCTCCTGCTATGACCCCAGGAGAATAAATATCACAAGCACTCCTCACAAGCAAAAAGAGTAACCAATAGTATGTTATCACAAGCAATCCCCGTGAAGAGACAGGTGAATGGGGCACGCCCCACTAAGGGGCCGCCTATGTATCCCCACTAAGTCCTGAATGCCCACTAAGCCGTCACAAGCACAACCTCCCACTCCTCACTCACATCACAAGCATAATCACAAGCACACTACCCACTAAGACGCATCACAAGCACACAAGCACAAGCACAAATAGTTCCCACTAAGCCGATATTCACAAGCATCACAAGCTCACAAGCACTCACAAGCATCACAAGCACACTACTGATCTAACCTCCCACTAAGACGTCTATTTTCACAAGCAAGCCCACTAAGAGTCACGGTCCCACTAAGGGATTAAAATATACGCATTCACAAGCACTAATCCCTCACAAGCACACGCAAGCTCACAAGCATTCCCGACGCATCATCACAAGCAACGCGCACACCGACTGAAATCTTCACAAGCAGACGCTTTTCCCGACGCCCCGACGCGTCCCGTCACAATCACAAGCAGCACTGGCCGTGCTACTCCCGACGCGACGCGCAAACTCCCGACGCCGCTAGAAGTCCCGACGCCCGGCCCCCACCCACTAAGACTAAGGTGGTCGAACCCACTAAGCCCCCACTAAGCGAGTACACTGTCTGCACTGTCTGCATTAGGAGTCTCTTGTAGGAACAGCCACTGTCTGCAGCAGAAAGCCCCACTTGCTAGTGTCTGTCTGCATGTCCTGTCTGCACGTATATATCCCGACGCGCTCCCTCCCGACGCCTTCTGTCTGCACTGCAAGACACTCAACTCGTCGAAGCTGTCTGCATTCCCGACGCTTTGGGAGAAGTAGTACGTTCTTTTAGCTTCCCGACGCCAGTCCCGACGCGGCTTATCTCTACTTCTGTCTGCAACCTGTCTGCAGAGTTCCCGACGCCAAGAGTAGAATTGAACATGAATAACCGTCCTATATTACCTCAGTCACGATACTGTCTGCACCATTCAACAGCTAGGCTAGCCCTTGTACTGTCTCTGTCTGCTGTCTGCATGTCTGCAATCGCTGTCTCGGATGCACGTCTGCACACGCGGATGCACGTCCTCGGATGCACGGATACGTACGGATGCACGGATGCACTGCAGGTCTCAGGCCGGCGGATGCACCACAACTAACGTTTCACAACGGATGCACGCTAGGGTCCTGTCTGCGGATGCACGCCCTACCGTATCTGTCCGGATGCACCGGATGCACGTTACGGGCCCCGGGCCGGATGCACGGCGCTAGGGCCGGATGCACGCCCGGATGCACACGATGCACCGGCCCCGGCCCGGCGGCGGCCCCGGCCCCGGCGGCCCGGATGCACCCGCGGATGCACGCGGCCCCGGCGGCCCCGGCGGGGCCCCCGGATGCACCGGCCCCGGCGGCCCGGATGCGGATGCACGCACCGGCGGCCGGATGCCGGATGCACGGGCTTGAAGGGCTTGAAGGGCCGGATGCACTTGAAGGGCTTGAAGGGCTTGAAGGGCTTGAAGGGCTTGAAGGGCTTGAAGGGCTTGAAGGGCTTGAAGGGCTTGAAGGGCGGATGCACCTTCGGATGCACGAAGGAGGGCTTGAGCTTGAAAGGGCTTGAGGGCTTGAAGAGGGCTTGAGGCTTGACGGATGCACAGGGCTTGAAGGGCTTGAAGGGCTTGAAGGGCTTGAAGGGCTTGAAGGGCTTGAAGGGCTTGA"
         9
         576
         16
        : string list)];
  [%expect {|
    (TTGAAGGGC TCACAAGCA GGGCTTGAA GGCTTGAAG GGCCTTGCA GCTTGAAGG GCTGTTTGA
     CTTGAAGGG CGGATGCAC AGGGCTTGA AGACCGTAG ACCCATGAG ACAGGTAAC AAGGGCTTG
     AACCGCCAA AAATAGTCC) |}]
;;
